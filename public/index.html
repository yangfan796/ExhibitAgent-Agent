<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>展会信息 Agent Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #0f172a; color: #e5e7eb; }
    header { padding: 16px; background: #111827; border-bottom: 1px solid #1f2937; }
    header h1 { margin: 0; font-size: 18px; }
    #chat { height: calc(100vh - 160px); overflow-y: auto; padding: 16px; }
    .msg { margin: 12px 0; max-width: 820px; }
    .user { background: #1f2937; padding: 12px; border-radius: 8px; }
    .assistant { background: #0b3d32; padding: 12px; border-radius: 8px; }
    .meta { font-size: 12px; color: #9ca3af; margin-bottom: 6px; }
    footer { position: fixed; bottom: 0; left: 0; right: 0; background: #111827; border-top: 1px solid #1f2937; padding: 12px; }
    form { display: flex; gap: 8px; max-width: 1024px; margin: 0 auto; }
    input[type=text] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #374151; background: #0f172a; color: #e5e7eb; }
    button { padding: 12px 16px; border-radius: 8px; border: 0; background: #2563eb; color: white; cursor: pointer; }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .link { color: inherit; cursor: pointer; text-decoration: underline; }
    .cards { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: #0b2532; border: 1px solid #183a4a; border-radius: 10px; padding: 12px; }
    .card h3 { margin: 0 0 8px; font-size: 16px; color: #c7d2fe; }
    .kv { display: grid; grid-template-columns: 100px 1fr; gap: 6px; font-size: 14px; }
    .kv div { color: #9ca3af; }
    .kv span { color: #e5e7eb; }
    .note { margin-top: 10px; font-size: 14px; color: #9ca3af; }
    #statusbar { padding: 6px 16px; font-size: 12px; color: #9ca3af; }
    table.md { width: 100%; border-collapse: collapse; margin: 8px 0; }
    table.md th, table.md td { border: 1px solid #183a4a; padding: 8px; font-size: 14px; }
    table.md th { background: #0b2532; color: #c7d2fe; }
    .export { margin-top: 8px; padding: 8px 12px; background: #2563eb; color: #fff; border: 0; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Node.js + WebSocket 聊天式 Agent（展会信息）</h1>
  </header>
  <div id="statusbar"></div>
  <div id="chat"></div>
  <footer>
    <form id="form">
      <input id="input" type="text" placeholder="例如：广州 2026 电子展 / 上海 纺织 展会">
      <button type="submit">发送</button>
    </form>
  </footer>
  <script>
    const chat = document.getElementById("chat");
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const statusbar = document.getElementById("statusbar");
    const API_BASE = localStorage.getItem("apiBase") || location.origin;
    let streamingEl = null;
    let streamingText = "";
    function add(role, content) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + role;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = role === "user" ? "你" : "Agent";
      const body = document.createElement("div");
      const parsed = tryParse(content);
      const hasEvents = parsed && Array.isArray(parsed.events) && parsed.events.length > 0;
      if (role === "assistant" && parsed) {
        if (hasEvents) {
          body.appendChild(renderCards(parsed));
        } else if (parsed.next_step || parsed.suggestions) {
          body.innerHTML = renderText(String(parsed.next_step || parsed.suggestions || ""));
        } else {
          body.innerHTML = renderText(content);
        }
      } else {
        body.innerHTML = renderText(content);
      }
      wrap.appendChild(meta);
      wrap.appendChild(body);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return wrap;
    }
    function renderMarkdown(text) {
      let t = String(text || "");
      t = stripAnchorTags(t);
      t = cleanLinkArtifacts(t);
      t = dedupeUrls(t);
      t = stripBackticksAroundUrls(t);
      t = t.replace(/```([\s\S]*?)```/g, (m, p1) => `<pre><code>${escape(p1)}</code></pre>`);
      t = t.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
      t = t.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
      t = t.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
      t = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      t = t.replace(/\*(.*?)\*/g, '<em>$1</em>');
      t = t.replace(/^\s*-\s+(.*)$/gm, '<ul><li>$1</li></ul>');
      t = t.replace(/^\s*\d+\.\s+(.*)$/gm, '<ol><li>$1</li></ol>');
      t = renderTables(t);
      t = safeLinkify(t);
      t = t.replace(/\n/g, "<br>");
      return t;
    }
    function stripAnchorTags(text) {
      return String(text || "").replace(/<\/?a\b[^>]*>/gi, "");
    }
    function cleanLinkArtifacts(text) {
      let t = String(text || "");
      t = t.replace(/["']\s*target="_blank"[^>]*>/gi, "");
      t = t.replace(/\)\s*target="_blank"[^>]*>/gi, ")");
      t = t.replace(/\s*rel="noopener"/gi, "");
      t = t.replace(/>\s*(https?:\/\/[^\s<)]+)/g, (m, url) => url);
      return t;
    }
    function dedupeUrls(text) {
      let t = String(text || "");
      t = t.replace(/(https?:\/\/[^\s<)]+)(?:\s*["'>\)]*\s*\1)+/g, "$1");
      return t;
    }
    function stripBackticksAroundUrls(text) {
      return String(text || "").replace(/`(https?:\/\/[^\s`]+)`/g, "$1");
    }
    function safeLinkify(text) {
      const TOKEN = "\u0000TABLE\u0000";
      const parts = String(text || "").replace(/(<table[\s\S]*?<\/table>)/g, TOKEN + "$1" + TOKEN).split(TOKEN);
      for (let i = 0; i < parts.length; i++) {
        // odd indices are table HTML, keep unchanged
        if (i % 2 === 0) {
          parts[i] = parts[i]
            .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)'">]+)\)/g, '<span class="link" data-url="$2">$1</span>')
            .replace(/(https?:\/\/[^\s<)'">]+)/g, '<span class="link" data-url="$1">$1</span>');
        }
      }
      return parts.join("");
    }
    function findFirstUrl(s) {
      const m = String(s || "").match(/https?:\/\/[^\s<)'">]+/);
      return m ? m[0] : "";
    }
    function renderText(text) {
      return renderMarkdown(text);
    }
    function renderTables(text) {
      const lines = text.split(/\r?\n/);
      let out = [];
      let i = 0;
      while (i < lines.length) {
        if (/\|/.test(lines[i]) && i + 1 < lines.length && /^\s*\|?\s*-+.*\|.*-+/.test(lines[i + 1])) {
          const header = lines[i].trim();
          const sep = lines[i + 1].trim();
          let rows = [];
          i += 2;
          while (i < lines.length && /\|/.test(lines[i])) {
            rows.push(lines[i].trim());
            i++;
          }
          out.push(buildTableHTML(header, rows));
        } else {
          out.push(lines[i]);
          i++;
        }
      }
      return out.join("\n");
    }
    function buildTableHTML(headerLine, rowLines) {
      const heads = headerLine.split("|").map(s => s.trim()).filter(Boolean);
      const rows = rowLines.map(l => l.split("|").map(s => s.trim()).filter(Boolean));
      let html = '<table class="md"><thead><tr>';
      heads.forEach(h => html += `<th>${escape(h)}</th>`);
      html += '</tr></thead><tbody>';
      rows.forEach(r => {
        html += '<tr>';
        heads.forEach((_, idx) => html += `<td>${renderCell(r[idx] || "")}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }
    function extractFirstTable(text) {
      const lines = String(text || "").split(/\r?\n/);
      for (let i = 0; i < lines.length - 1; i++) {
        if (/\|/.test(lines[i]) && /^\s*\|?\s*-+.*\|.*-+/.test(lines[i + 1])) {
          const header = lines[i].trim().split("|").map(s => s.trim()).filter(Boolean);
          let rows = [];
          i += 2;
          while (i < lines.length && /\|/.test(lines[i])) {
            rows.push(lines[i].trim().split("|").map(s => s.trim()).filter(Boolean));
            i++;
          }
          return { header, rows };
        }
      }
      return null;
    }
    function attachExport(container, table) {
      const btn = document.createElement("button");
      btn.className = "export";
      btn.textContent = "导出Excel(CSV)";
      btn.onclick = () => downloadCSV(table);
      container.appendChild(btn);
    }
    function downloadCSV(table) {
      const { header, rows } = table;
      const escapeCSV = s => `"${String(s || "").replace(/"/g, '""')}"`;
      const normalizeCell = s => {
        const md = String(s || "");
        const m = md.match(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/);
        if (m) return m[2]; // 取URL
        const url = md.match(/https?:\/\/[^\s)]+/);
        if (url) return url[0];
        return md.replace(/\s+/g, " ").trim();
      };
      let csv = header.map(h => escapeCSV(normalizeCell(h))).join(",") + "\n";
      rows.forEach(r => {
        const row = header.map((_, idx) => escapeCSV(normalizeCell(r[idx] || "")));
        csv += row.join(",") + "\n";
      });
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function tableFromEvents(events) {
      if (!Array.isArray(events) || events.length === 0) return null;
      const header = ["名称","时间","城市","地点","主办","官网","简介"];
      const rows = events.map(ev => [
        ev.name || "",
        ev.date || "",
        ev.city || "",
        ev.venue || "",
        ev.organizer || "",
        ev.website ? `[官网](${ev.website})` : "",
        ev.description || ""
      ]);
      return { header, rows };
    }
    function renderCell(s) {
      const text = String(s || "");
      const m = text.match(/^\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)$/);
      if (m) {
        return `<span class="link" data-url="${escape(m[2])}">${escape(m[1])}</span>`;
      }
      const u = findFirstUrl(text);
      if (u) {
        return `<span class="link" data-url="${escape(u)}">${escape(u)}</span>`;
      }
      // 其他内容按纯文本
      return escape(text);
    }
    function tryParse(text) {
      try { return JSON.parse(text); } catch { return null; }
    }
    function renderCards(data) {
      const container = document.createElement("div");
      const grid = document.createElement("div");
      grid.className = "cards";
      (data.events || []).forEach(ev => {
        const c = document.createElement("div");
        c.className = "card";
        const h = document.createElement("h3");
        h.textContent = ev.name || "未命名展会";
        c.appendChild(h);
        const kv = document.createElement("div");
        kv.className = "kv";
        kv.innerHTML = `
          <div>时间</div><span>${escape(ev.date)}</span>
          <div>城市</div><span>${escape(ev.city)}</span>
          <div>地点</div><span>${escape(ev.venue)}</span>
          <div>主办</div><span>${escape(ev.organizer)}</span>
          <div>官网</div><span>${linkify(ev.website)}</span>
        `;
        c.appendChild(kv);
        if (ev.description) {
          const d = document.createElement("div");
          d.className = "note";
          d.textContent = ev.description;
          c.appendChild(d);
        }
        grid.appendChild(c);
      });
      container.appendChild(grid);
      if (data.suggestions) {
        const note = document.createElement("div");
        note.className = "note";
        note.textContent = data.suggestions;
        container.appendChild(note);
      }
      return container;
    }
    function escape(s) {
      return String(s || "").replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }
    function linkify(url) {
      const u = findFirstUrl(url);
      return u ? `<span class="link" data-url="${escape(u)}">${escape(u)}</span>` : "";
    }
    async function sendText(text) {
      statusbar.textContent = "正在思考中…";
      streamingEl = add("assistant", "");
      streamingText = "";
      const body = streamingEl.children[1];
      const res = await fetch(API_BASE + "/api/chat-stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        const lines = chunk.split(/\r?\n/).filter(Boolean);
        for (const line of lines) {
          const m = line.match(/^data:\s*(.*)$/);
          if (!m) continue;
          const payload = m[1];
          if (payload === "[FINAL]") {
            statusbar.textContent = "";
            const t = extractFirstTable(streamingText);
            if (t) attachExport(body, t);
            streamingEl = null;
            streamingText = "";
            continue;
          }
          streamingText += payload;
          body.innerHTML = renderMarkdown(streamingText);
          chat.scrollTop = chat.scrollHeight;
        }
      }
      statusbar.textContent = "";
    }
    form.addEventListener("submit", ev => {
      ev.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      add("user", text);
      sendText(text).catch(err => {
        statusbar.textContent = "出错：" + String(err?.message || err);
      });
      input.value = "";
      input.focus();
    });
    chat.addEventListener("click", ev => {
      const el = ev.target.closest(".link");
      if (el) {
        const url = el.getAttribute("data-url");
        if (url) window.open(url, "_blank", "noopener");
      }
    });
  </script>
</body>
</html>
